(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[729],{7028:function(e,t,r){Promise.resolve().then(r.bind(r,6571))},1354:function(e,t,r){"use strict";r.d(t,{G:function(){return n}});let n=[{id:"any",name:"指名なし",role:"Any"},{id:"sakura",name:"サクラ",role:"Top Stylist"},{id:"kenji",name:"ケンジ",role:"Director"},{id:"rookie",name:"Rookie",role:"Staff"}]},6571:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return y}});var n=r(5853),a=r(2619),s=r(645),i=r(1182),d=r(4254),l=r(7798),o=r(3790),c=r(3035);let u=(0,c.Z)("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]),m=(0,c.Z)("ChevronRight",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]);var x=r(857),b=r(2043),f=r(1354),h=r(3346),p=r(3838);function g(){let[e,t]=(0,d.useState)(!1),[r,a]=(0,d.useState)("");(0,d.useEffect)(()=>{t(!0),a(new Date().toISOString().split("T")[0])},[]);let[s,i]=(0,d.useState)("");(0,d.useEffect)(()=>{e&&r&&i(r)},[e,r]);let[c,g]=(0,d.useState)([]),[y,j]=(0,d.useState)(!1),[v,w]=(0,d.useState)(null),[N,k]=(0,d.useState)(null),[S,E]=(0,d.useState)(null),[C,I]=(0,d.useState)(""),[A,O]=(0,d.useState)(null),[D,F]=(0,d.useState)([]),[M,G]=(0,d.useState)(!1),[Z,P]=(0,d.useState)(new Map),[Y,R]=(0,d.useState)(null),T=function(){let e=[];for(let t=10;t<=19;t++)e.push("".concat(t.toString().padStart(2,"0"),":00"));return e}();(0,d.useEffect)(()=>{(async()=>{try{let e=await (0,p.BH)();R(e)}catch(e){console.warn("Failed to fetch settings:",e)}})()},[]),(0,d.useEffect)(()=>{let e=new Map;D.forEach(t=>{if("any"!==t.id)try{let r="lumiere.staffShift.".concat(t.id),n=localStorage.getItem(r);if(n){let r=JSON.parse(n);e.set(t.id,r)}}catch(e){console.warn("Failed to load shift for staff ".concat(t.id,":"),e)}}),P(e)},[D]);let _=[{id:"any",name:"指名なし",role:void 0,active:!0,sortOrder:0},...D],L=new Map;c.forEach(e=>{let t=e.staffId||"any",r="".concat(e.date,"|").concat(e.time,"|").concat(t);L.set(r,e)});let z=(0,d.useCallback)(async()=>{j(!0),w(null);try{let e=await (0,l.IF)(s);Array.isArray(e.reservations)?g(e.reservations):(console.warn("fetchReservations: response.reservations is not an array, setting to empty array"),g([]))}catch(e){w(e instanceof o.GY?e.message:e instanceof Error?e.message:"Failed to fetch reservations"),g([])}finally{j(!1)}},[s]);(0,d.useEffect)(()=>{s&&z()},[s,z]),(0,d.useEffect)(()=>{(async()=>{try{let e=await (0,l.Dh)();Array.isArray(e)?F(e):(console.warn("fetchStaff: staff is not an array, using fallback"),F(f.G.filter(e=>"any"!==e.id).map(e=>({id:e.id,name:e.name,role:e.role,active:!0,sortOrder:0}))))}catch(e){console.warn("Failed to fetch staff, using fallback:",e),F(f.G.filter(e=>"any"!==e.id).map(e=>({id:e.id,name:e.name,role:e.role,active:!0,sortOrder:0})))}})()},[]);let J=e=>{let t=new Date(s);t.setDate(t.getDate()+e),i(t.toISOString().split("T")[0])},B=async e=>{if(window.confirm("予約をキャンセルしますか？\n日付: ".concat(e.date,"\n時間: ").concat(e.time,"\nお名前: ").concat(e.name))){E(e.reservationId);try{await (0,l.Ml)(e.reservationId),await z(),k(null)}catch(e){if(e instanceof o.GY&&404===e.status)await z(),k(null);else if(e instanceof o.GY&&409===e.status){let t=e.message||"";t.includes("already canceled")||t.includes("既にキャンセル")?(w("既にキャンセル済みです"),await z(),k(null)):w(e.message||"キャンセル期限を過ぎています")}else w(e instanceof o.GY?e.message:e instanceof Error?e.message:"Failed to cancel reservation")}finally{E(null)}}},H=(e,t)=>{let r="".concat(s,"|").concat(e,"|").concat(t);return L.get(r)},W=e=>e.staffId||"any",q=async()=>{if(N&&C){G(!0),w(null);try{let e=N.reservationId,t="any"===C?null:C;await (0,l.Ip)(e,t),await z(),k(null),I(""),O(null)}catch(e){w(e instanceof o.GY?e.message:e instanceof Error?e.message:"Failed to assign staff")}finally{G(!1)}}};return(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsx)("div",{className:"bg-white rounded-2xl shadow-soft border border-brand-border p-6",children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsx)("h1",{className:"text-2xl font-semibold text-brand-text",children:"予約台帳"}),(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsx)("button",{onClick:()=>J(-1),className:"p-2 text-brand-muted hover:text-brand-text hover:bg-brand-bg rounded-xl transition-all",children:(0,n.jsx)(u,{className:"w-5 h-5"})}),(0,n.jsx)("div",{className:"px-4 py-2 bg-brand-bg border border-brand-border rounded-xl",children:(0,n.jsx)("span",{className:"text-sm font-medium text-brand-text",children:(e=>{let t=new Date(e);return"".concat(t.getFullYear(),"/").concat((t.getMonth()+1).toString().padStart(2,"0"),"/").concat(t.getDate().toString().padStart(2,"0"),"(").concat(["日","月","火","水","木","金","土"][t.getDay()],")")})(s)})}),(0,n.jsx)("button",{onClick:()=>J(1),className:"p-2 text-brand-muted hover:text-brand-text hover:bg-brand-bg rounded-xl transition-all",children:(0,n.jsx)(m,{className:"w-5 h-5"})})]}),(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsx)("button",{onClick:()=>{i(r)},className:"px-4 py-2 text-sm font-medium text-brand-text bg-white border border-brand-border rounded-xl hover:shadow-md transition-all",children:"今日"}),(0,n.jsxs)("button",{onClick:()=>{alert("予約作成機能は準備中です")},className:"px-5 py-4 bg-brand-primary text-white rounded-2xl shadow-soft hover:shadow-md transition-all flex items-center gap-2 leading-tight",children:[(0,n.jsx)(x.Z,{className:"w-5 h-5"}),(0,n.jsx)("span",{className:"font-medium",children:"予約作成"})]})]})]})}),v&&(0,n.jsx)("div",{className:"p-4 bg-red-50 border border-red-200 rounded-2xl",children:(0,n.jsx)("p",{className:"text-sm text-red-700",children:v})}),(0,n.jsx)("div",{className:"bg-white rounded-2xl shadow-soft border border-brand-border overflow-hidden",children:y?(0,n.jsxs)("div",{className:"flex items-center justify-center py-12",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-brand-primary"}),(0,n.jsx)("span",{className:"ml-3 text-sm text-brand-muted",children:"読み込み中..."})]}):(0,n.jsx)("div",{className:"overflow-auto max-h-[calc(100vh-300px)]",children:(0,n.jsxs)("table",{className:"min-w-full border-collapse",children:[(0,n.jsx)("thead",{className:"bg-brand-bg sticky top-0 z-10",children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{className:"sticky left-0 z-20 bg-brand-bg border-r border-brand-border px-4 py-3 text-left text-xs font-semibold text-brand-muted uppercase tracking-wider min-w-[80px]",children:"TIME"}),_.map(e=>(0,n.jsx)("th",{className:"border-r border-brand-border px-4 py-3 text-center text-xs font-semibold text-brand-muted uppercase tracking-wider min-w-[200px] last:border-r-0",children:(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"font-medium text-brand-text",children:e.name}),e.role&&(0,n.jsxs)("div",{className:"text-xs text-brand-muted mt-1",children:["(",e.role,")"]})]})},e.id))]})}),(0,n.jsx)("tbody",{className:"bg-white divide-y divide-brand-border",children:T.map(e=>(0,n.jsxs)("tr",{className:"hover:bg-brand-bg/50 transition-colors",children:[(0,n.jsx)("td",{className:"sticky left-0 z-10 bg-white border-r border-brand-border px-4 py-3 text-sm font-medium text-brand-text min-w-[80px]",children:e}),_.map(t=>{let r=H(e,t.id),a="any"===t.id||(0,h.wS)(s,e,Z.get(t.id)||null);return(0,n.jsx)("td",{className:"border-r border-brand-border px-2 py-2 min-w-[200px] last:border-r-0 align-top ".concat(a?"":"bg-gray-100 opacity-50"),children:r?(0,n.jsxs)("div",{onClick:()=>a&&k(r),className:"border rounded-xl p-3 transition-all ".concat(a?"bg-blue-50 border-blue-200 cursor-pointer hover:shadow-md":"bg-gray-100 border-gray-200 cursor-not-allowed opacity-50"),children:[(0,n.jsx)("div",{className:"font-medium text-brand-text text-sm mb-1",children:r.name}),(0,n.jsx)("div",{className:"text-xs text-brand-muted mb-2",children:r.phone||"-"}),(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsx)(b.Z,{variant:"reserved",children:"予約済み"}),(0,n.jsx)("span",{className:"text-xs text-brand-muted font-mono",children:r.reservationId.slice(0,8)})]})]}):(0,n.jsx)("div",{className:"h-16 ".concat(a?"":"bg-gray-50")})},"".concat(e,"-").concat(t.id))})]},e))})]})})}),N&&(0,n.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",onClick:()=>k(null),children:(0,n.jsxs)("div",{className:"bg-white rounded-2xl shadow-soft max-w-2xl w-full p-6 space-y-6",onClick:e=>e.stopPropagation(),children:[(0,n.jsxs)("div",{className:"flex items-start justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h2",{className:"text-2xl font-semibold text-brand-text",children:"予約詳細"}),(0,n.jsxs)("p",{className:"text-sm text-brand-muted mt-1",children:["予約ID: ",N.reservationId]})]}),(0,n.jsx)("button",{onClick:()=>k(null),className:"p-2 text-brand-muted hover:text-brand-text hover:bg-brand-bg rounded-lg transition-all",children:(0,n.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"text-sm font-medium text-brand-muted mb-1",children:"日付"}),(0,n.jsx)("p",{className:"text-base text-brand-text",children:N.date})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"text-sm font-medium text-brand-muted mb-1",children:"時間"}),(0,n.jsx)("p",{className:"text-base text-brand-text",children:N.time})]})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"text-sm font-medium text-brand-muted mb-1",children:"お名前"}),(0,n.jsx)("p",{className:"text-base text-brand-text",children:N.name})]}),N.phone&&(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"text-sm font-medium text-brand-muted mb-1",children:"電話番号"}),(0,n.jsx)("p",{className:"text-base text-brand-text",children:N.phone})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"text-sm font-medium text-brand-muted mb-1",children:"作成日時"}),(0,n.jsx)("p",{className:"text-base text-brand-text",children:e?(()=>{try{return new Date(N.createdAt).toLocaleString("ja-JP")}catch(e){return N.createdAt}})():N.createdAt})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"text-sm font-medium text-brand-muted mb-1",children:"ステータス"}),(0,n.jsx)("div",{children:(0,n.jsx)(b.Z,{variant:"reserved",children:"予約済み"})})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{className:"text-sm font-medium text-brand-muted mb-1",children:"担当者"}),(0,n.jsx)("p",{className:"text-base text-brand-text",children:(()=>{let e=W(N);if("any"===e)return"指名なし";let t=D.find(t=>t.id===e);return t?t.name:"指名なし"})()})]}),"any"===W(N)&&(0,n.jsxs)("div",{className:"border-t border-brand-border pt-4 mt-4",children:[(0,n.jsx)("h3",{className:"text-lg font-semibold text-brand-text mb-3",children:"担当者を割り当て"}),(0,n.jsxs)("div",{className:"space-y-3",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{htmlFor:"assign-staff",className:"block text-sm font-medium text-brand-text mb-2",children:"スタッフを選択"}),(0,n.jsxs)("select",{id:"assign-staff",value:C,onChange:e=>I(e.target.value),className:"w-full px-4 py-3 border border-brand-border rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-primary/20 focus:border-brand-primary transition-all bg-white",children:[(0,n.jsx)("option",{value:"",children:"選択してください"}),D.filter(e=>{if(!N)return!1;let t=Z.get(e.id);return(0,h.wS)(N.date,N.time,t||null)}).map(e=>(0,n.jsxs)("option",{value:e.id,children:[e.name," ",e.role?"(".concat(e.role,")"):""]},e.id))]})]}),(0,n.jsx)("button",{onClick:q,disabled:!C,className:"w-full px-4 py-3 bg-brand-primary text-white rounded-xl font-medium hover:shadow-md focus:outline-none focus:ring-2 focus:ring-brand-primary focus:ring-offset-2 disabled:bg-brand-muted disabled:cursor-not-allowed transition-all",children:"割り当て"}),(0,n.jsx)("p",{className:"text-xs text-brand-muted",children:"※ 現時点では画面表示のみ更新されます。API連携は準備中です。"})]})]})]}),(0,n.jsx)("div",{className:"flex items-center gap-2 pt-4 border-t border-brand-border",children:(0,n.jsx)("button",{onClick:()=>{k(null),B(N)},disabled:S===N.reservationId,className:"px-4 py-2 text-sm font-medium text-rose-600 bg-rose-50 border border-rose-200 rounded-xl hover:bg-rose-100 focus:outline-none focus:ring-2 focus:ring-rose-500/20 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all",children:S===N.reservationId?"キャンセル中...":"キャンセル"})})]})})]})}function y(){return(0,n.jsx)(a.Z,{sidebar:(0,n.jsx)(i.Z,{}),topbar:(0,n.jsx)(s.Z,{title:"予約管理",subtitle:"予約の一覧と管理を行います。"}),children:(0,n.jsx)(g,{})})}},3838:function(e,t,r){"use strict";r.d(t,{BH:function(){return s}});var n=r(3790);let a={publicDays:14,tenant:{name:"",email:""},businessHours:{openTime:"10:00",closeTime:"19:00"},closedWeekdays:[0],exceptions:[],rules:{cutoffMinutes:120,cancelMinutes:1440,anyCapacityPerSlot:1},notifications:{enableAdminNotify:!1,slackWebhookUrl:"",email:"",enableCustomerNotify:!1},assignment:{mode:"manual",strategy:"priority",priorityOrder:[]},integrations:{line:{connected:!1,notifyOnReservation:!0,notifyOnCancel:!0,notifyOnReminder:!1},stripe:{connected:!1}}};async function s(){try{let e=await (0,n.R1)("/admin/settings");if(e.ok&&e.data)return i(e.data,a);throw Error(e.error||"Failed to fetch settings")}catch(e){return console.warn("Failed to fetch settings from API, trying localStorage:",e),function(){try{let e=localStorage.getItem("lumiere.adminSettings");if(e){let t=JSON.parse(e);return i(t,a)}}catch(e){console.warn("Failed to load from localStorage:",e)}return a}()}}function i(e,t){if(!e)return t;let r={...t};for(let[n,a]of Object.entries(e)){if(null==a)continue;let e=t[n],s="object"==typeof a&&null!==a&&!Array.isArray(a),d="object"==typeof e&&null!==e&&!Array.isArray(e);s&&d?r[n]=i(a,e):r[n]=a}return r}},3346:function(e,t,r){"use strict";function n(e){let[t,r]=e.split(":").map(Number);return 60*t+r}function a(){let e=[];for(let t=10;t<=20;t++)for(let r=0;r<60;r+=30){let n="".concat(t.toString().padStart(2,"0"),":").concat(r.toString().padStart(2,"0"));e.push(n)}return e}function s(e){let t=a(),r=n(e);return t.filter(e=>n(e)>r)}function i(e){var t,r;if(!e.enabled)return{valid:!0};if(t=e.start,r=e.end,!(n(t)<n(r)))return{valid:!1,error:"終了時刻は開始時刻より後である必要があります"};if(e.breakStart||e.breakEnd){if(!e.breakStart||!e.breakEnd)return{valid:!1,error:"休憩開始時刻と終了時刻の両方を入力してください"};if(!function(e,t,r,a){if(!r||!a)return!0;let s=n(e),i=n(t),d=n(r),l=n(a);return s<d&&d<l&&l<i}(e.start,e.end,e.breakStart,e.breakEnd))return{valid:!1,error:"休憩時間は勤務時間の範囲内である必要があります"}}return{valid:!0}}function d(){return[{dow:0,enabled:!1,start:"10:00",end:"19:00"},{dow:1,enabled:!0,start:"10:00",end:"19:00"},{dow:2,enabled:!0,start:"10:00",end:"19:00"},{dow:3,enabled:!0,start:"10:00",end:"19:00"},{dow:4,enabled:!0,start:"10:00",end:"19:00"},{dow:5,enabled:!0,start:"10:00",end:"19:00"},{dow:6,enabled:!0,start:"10:00",end:"18:00"}].map(e=>({dow:e.dow,enabled:e.enabled,start:e.start,end:e.end}))}function l(e){return["日","月","火","水","木","金","土"][e]}function o(e,t,r){if(!r)return!0;let a=new Date(e).getDay(),s=n(t),i=r.exceptions.find(t=>t.date===e);if(i){if("off"===i.type)return!1;if("custom"===i.type&&i.start&&i.end){let e=n(i.start),t=n(i.end);if(i.breakStart&&i.breakEnd){let e=n(i.breakStart),t=n(i.breakEnd);if(s>=e&&s<t)return!1}return s>=e&&s<t}}let d=r.weekly.find(e=>e.dow===a);if(!d||!d.enabled)return!1;let l=n(d.start),o=n(d.end);if(d.breakStart&&d.breakEnd){let e=n(d.breakStart),t=n(d.breakEnd);if(s>=e&&s<t)return!1}return s>=l&&s<o}r.d(t,{Jl:function(){return d},Ot:function(){return l},Ph:function(){return a},YC:function(){return s},a$:function(){return i},wS:function(){return o}})}},function(e){e.O(0,[856,269,285,749,744],function(){return e(e.s=7028)}),_N_E=e.O()}]);
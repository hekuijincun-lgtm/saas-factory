"use strict";(()=>{var e={};e.id=533,e.ids=[533],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},329:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>R,requestAsyncStorage:()=>d,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>h});var a={};r.r(a),r.d(a,{GET:()=>u});var n=r(7849),i=r(4966),o=r(9169),s=r(1237);let c=require("crypto");var l=r.n(c);async function u(e){let t=new URL(e.url),r=t.searchParams.get("tenantId")??"default",a=t.searchParams.get("code"),n=t.searchParams.get("state"),i=t.searchParams.get("error");if(i)return s.NextResponse.redirect(new URL(`/login?e=${encodeURIComponent(i)}`,t.origin));if(!a||!n)return s.NextResponse.redirect(new URL("/login?e=missing_code_or_state",t.origin));let o=process.env.WORKER_BASE_URL??"http://127.0.0.1:8787",c=await fetch(`${o}/admin/integrations/line/oauth/callback?tenantId=${encodeURIComponent(r)}`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({code:a,state:n}),cache:"no-store"}),u=await c.json().catch(()=>null);if(!c.ok||!u?.ok){let e=u?.error??"callback_failed";return s.NextResponse.redirect(new URL(`/login?e=${encodeURIComponent(e)}`,t.origin))}let p=process.env.WEB_SESSION_SECRET??"dev-secret-change-me",d=Date.now(),h=function(e,t){let r=Buffer.from(JSON.stringify(e)).toString("base64url"),a=l().createHmac("sha256",t).update(r).digest("base64url");return`${r}.${a}`}({tenantId:r,lineUserId:u?.line?.userId??null,at:d,v:1},p),g=s.NextResponse.redirect(new URL("/admin/settings?line=ok",t.origin));return g.cookies.set("kb_session",h,{httpOnly:!0,secure:!1,sameSite:"lax",path:"/",maxAge:604800}),g}let p=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/auth/line/callback/route",pathname:"/api/auth/line/callback",filename:"route",bundlePath:"app/api/auth/line/callback/route"},resolvedPagePath:"C:\\dev\\saas-factory\\apps\\web\\app\\api\\auth\\line\\callback\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:d,staticGenerationAsyncStorage:h,serverHooks:g}=p,m="/api/auth/line/callback/route";function R(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:h})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[352,444],()=>r(329));module.exports=a})();
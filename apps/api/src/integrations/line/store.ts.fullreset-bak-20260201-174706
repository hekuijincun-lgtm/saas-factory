// src/integrations/line/store.ts
// D1-backed store for LINE integration + logs (minimal, defensive).

export type LineIntegrationRow = {
  tenant_id: string
  user_id: string
  display_name: string | null
  picture_url: string | null
  notify_enabled: number // 0/1
  created_at: string
  updated_at: string
}

export type LineWebhookLogRow = {
  id: string
  ts: string
  tenant_id: string
  event_type: string | null
  msg_type: string | null
  reply_token_len: number | null
  body_len: number
  reply_status: number | null
  reply_body: string | null
}

export async function getIntegration(db: D1Database, tenantId: string) {
  try {
    const row = await db
      .prepare("SELECT * FROM line_integrations WHERE tenant_id = ?1 LIMIT 1")
      .bind(tenantId)
      .first()
    return row ?? null
  } catch {
    return null
  }
}

export async function upsertIntegration(
  db: D1Database,
  tenantId: string,
  patch?: Partial<{
    userId: string
    displayName?: string
    pictureUrl?: string
    updatedAt?: string
    notify_enabled?: number
  }>
) {
  const userId = (patch?.userId ?? "").toString().trim()
  if (!userId) {
    console.error("[LINE][store] missing userId patch=", patch)
    throw new Error("missing line userId")
  }

  await ensureLineIntegrationsTable(db)

  const now = (patch?.updatedAt ?? new Date().toISOString()).toString()
  const displayName = (patch?.displayName ?? null) as any
  const pictureUrl = (patch?.pictureUrl ?? null) as any
  const notifyEnabled =
    typeof patch?.notify_enabled === "number" ? patch.notify_enabled : 1

  const sql =
    "INSERT INTO line_integrations " +
    "(tenant_id, user_id, display_name, picture_url, notify_enabled, created_at, updated_at) " +
    "VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7) " +
    "ON CONFLICT(tenant_id) DO UPDATE SET " +
    "user_id = excluded.user_id, " +
    "display_name = excluded.display_name, " +
    "picture_url = excluded.picture_url, " +
    "notify_enabled = excluded.notify_enabled, " +
    "updated_at = excluded.updated_at"

  await db.prepare(sql).bind(tenantId, userId, displayName, pictureUrl, notifyEnabled, now, now).run()

  const saved = await db
    .prepare("SELECT * FROM line_integrations WHERE tenant_id = ?1 LIMIT 1")
    .bind(tenantId)
    .first()

  return saved as any
}

export async function setNotifyEnabled(
  db: D1Database,
  tenantId: string,
  enabled: boolean
) {
  await ensureLineIntegrationsTable(db)

  const now = new Date().toISOString()
  const sql =
    "INSERT INTO line_integrations (tenant_id, notify_enabled, created_at, updated_at) " +
    "VALUES (?1, ?2, ?3, ?4) " +
    "ON CONFLICT(tenant_id) DO UPDATE SET " +
    "notify_enabled = excluded.notify_enabled, " +
    "updated_at = excluded.updated_at"

  await db.prepare(sql).bind(tenantId, enabled ? 1 : 0, now, now).run()
  return { ok: true as const }
}

export async function disconnectIntegration(db: D1Database, tenantId: string) {
  await ensureLineIntegrationsTable(db)

  const now = new Date().toISOString()
  const sql =
    "INSERT INTO line_integrations (tenant_id, notify_enabled, created_at, updated_at) " +
    "VALUES (?1, 0, ?2, ?3) " +
    "ON CONFLICT(tenant_id) DO UPDATE SET " +
    "notify_enabled = 0, " +
    "updated_at = excluded.updated_at"

  await db.prepare(sql).bind(tenantId, now, now).run()
  return { ok: true as const }
}

export async function insertSendLog(
  db: D1Database,
  tenantId: string,
  status: number,
  body: string
) {
  try {
    await ensureLineSendLogsTable(db)
    const id = crypto.randomUUID()
    const ts = new Date().toISOString()
    const sql =
      "INSERT INTO line_send_logs (id, ts, tenant_id, status, body) " +
      "VALUES (?1, ?2, ?3, ?4, ?5)"
    await db.prepare(sql).bind(id, ts, tenantId, status, (body ?? "").slice(0, 2000)).run()
  } catch {
    // ignore
  }
}

export async function insertLineWebhookLog(
  db: D1Database,
  row: LineWebhookLogRow
) {
  const sql =
    "INSERT INTO line_webhook_logs (id, ts, tenant_id, event_type, msg_type, reply_token_len, body_len, reply_status, reply_body) " +
    "VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8, ?9)"
  await db
    .prepare(sql)
    .bind(
      row.id,
      row.ts,
      row.tenant_id,
      row.event_type,
      row.msg_type,
      row.reply_token_len,
      row.body_len,
      row.reply_status,
      row.reply_body
    )
    .run()
}

export async function listLineWebhookLogs(
  db: D1Database,
  tenantId: string,
  limit: number
) {
  const sql =
    "SELECT id, ts, tenant_id, event_type, msg_type, reply_status " +
    "FROM line_webhook_logs WHERE tenant_id = ?1 ORDER BY ts DESC LIMIT ?2"
  const res = await db.prepare(sql).bind(tenantId, limit).all()
  return (res.results ?? []) as Array<{
    id: string
    ts: string
    tenant_id: string
    event_type: string | null
    msg_type: string | null
    reply_status: number | null
  }>
}

export async function getLineWebhookLog(db: D1Database, id: string) {
  const sql = "SELECT * FROM line_webhook_logs WHERE id = ?1 LIMIT 1"
  const res = await db.prepare(sql).bind(id).first()
  return res ?? null
}

async function ensureLineIntegrationsTable(db: D1Database) {
  // NOTE: template string so newlines are safe
  const sql = CREATE TABLE IF NOT EXISTS line_integrations (
    tenant_id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    display_name TEXT,
    picture_url TEXT,
    notify_enabled INTEGER NOT NULL DEFAULT 1,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
  )
  await db.prepare(sql).run()
}









